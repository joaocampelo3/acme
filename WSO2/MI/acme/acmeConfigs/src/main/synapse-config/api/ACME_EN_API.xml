<?xml version="1.0" encoding="UTF-8"?>
<api context="/acme/en" hostname="localhost" name="ACME_EN_API" port="8243" statistics="enable" version="1.0.0" version-type="url" xmlns="http://ws.apache.org/ns/synapse">
    <resource methods="GET" uri-template="/products">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Get Products"/>
            </log>
            <send>
                <endpoint key="ProductsEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="POST" uri-template="/products">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Post Products"/>
            </log>
            <send>
                <endpoint key="ProductsEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/products/{sku}">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Get Products by SKU"/>
            </log>
            <send>
                <endpoint key="ProductsEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="DELETE" uri-template="/products/{sku}">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Delete Products by SKU"/>
            </log>
            <send>
                <endpoint key="ProductsEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="PATCH" uri-template="/products/{sku}">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Update Products by SKU"/>
            </log>
            <send>
                <endpoint key="ProductsEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/products/designation/{designation}">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Get All Products by Designation"/>
            </log>
            <send>
                <endpoint key="ProductsEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/products/{sku}/reviews/{status}">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Get Reviews by status of products by sku"/>
            </log>
            <send>
                <endpoint key="ReviewsProductsEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/reviews/pending">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Get all Reviews with pending status"/>
            </log>
            <send>
                <endpoint key="ReviewsEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="POST" uri-template="/products/{sku}/reviews">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Create Reviews for a product"/>
            </log>
            <send>
                <endpoint key="ReviewsEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="DELETE" uri-template="/reviews/{reviewID}">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Delete Reviews by ID"/>
            </log>
            <send>
                <endpoint key="ReviewsEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="PUT" uri-template="/reviews/acceptreject/{reviewID}">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Accept or Reject Reviews by ID"/>
            </log>
            <send>
                <endpoint key="ReviewsEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/votes">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Get all Votes"/>
            </log>
            <send>
                <endpoint key="VotesEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/votes/{voteID}">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Get Vote by ID"/>
            </log>
            <send>
                <endpoint key="VotesEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="DELETE" uri-template="/votes/{voteID}">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Delete Vote by ID"/>
            </log>
            <send>
                <endpoint key="VotesEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="PATCH" uri-template="/votes/{voteID}">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Update Vote by ID"/>
            </log>
            <send>
                <endpoint key="VotesEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="POST" uri-template="/review/{reviewUuid}/votes">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Create Vote for Review"/>
            </log>
            <send>
                <endpoint key="VotesReviewsEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="POST" uri-template="/noreview/{sku}/votes">
        <inSequence>
            <log description="request log" level="custom">
                <property name="message" value="Welcome to ACME - Create Vote without Review"/>
            </log>
            <send>
                <endpoint key="VotesNoReviewsEndpoint"/>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/reviews/{voteType}/moreXvotes/{numberOfVotes}">
        <inSequence>
            <log description="request log">
                <property name="message" value="Welcome to ACME -Get Review with more than X up/down votes"/>
            </log>
            <property description="SET numberOfVotes Property" expression="$ctx:uri.var.numberOfVotes" name="numberOfVotesProperty" scope="default" type="INTEGER"/>
            <call>
                <endpoint key="ReviewsEndpoint"/>
            </call>
            <switch source="get-property('uri.var.voteType')">
                <case regex="upvote">
                    <script language="js"><![CDATA[var payload = mc.getPayloadJSON();
		                    var numberOfVotes = mc.getProperty('numberOfVotesProperty');
		
		                     // Filter the payload based on the numberOfVotes
		                    var filteredPayload = payload.filter(function(item) {
		                      return item.upVotes > numberOfVotes;
		                    });
		
		                    // Replace the original payload with the filtered payload
		                    mc.setPayloadJSON(filteredPayload);]]></script>
                    <respond/>
                </case>
                <default>
                    <script language="js"><![CDATA[var payload = mc.getPayloadJSON();
		                    var numberOfVotes = mc.getProperty('numberOfVotesProperty');
		
		                    // Filter the payload based on the numberOfVotes
		                    var filteredPayload = payload.filter(function(item) {
		                      return item.downVotes > numberOfVotes;
		                    });
		
		                    // Replace the original payload with the filtered payload
		                    mc.setPayloadJSON(filteredPayload);]]></script>
                    <respond/>
                </default>
            </switch>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/reviews/{voteType}/lessXvotes/{numberOfVotes}">
        <inSequence>
            <log description="request log">
                <property name="message" value="Welcome to ACME - Get Review with less than X up/down votes"/>
            </log>
            <property description="SET numberOfVotes Property" expression="$ctx:uri.var.numberOfVotes" name="numberOfVotesProperty" scope="default" type="INTEGER"/>
            <call>
                <endpoint key="ReviewsEndpoint"/>
            </call>
            <switch source="get-property('uri.var.voteType')">
                <case regex="upvote">
                    <script language="js"><![CDATA[var payload = mc.getPayloadJSON();
		                    var numberOfVotes = mc.getProperty('numberOfVotesProperty');
		
		                    // Filter the payload based on the numberOfVotes
		                    var filteredPayload = payload.filter(function(item) {
		                        return item.upVotes < numberOfVotes;
		                    });
		
		                    // Replace the original payload with the filtered payload
		                    mc.setPayloadJSON(filteredPayload);]]></script>
                    <respond/>
                </case>
                <default>
                    <script language="js"><![CDATA[var payload = mc.getPayloadJSON();
		                    var numberOfVotes = mc.getProperty('numberOfVotesProperty');
		
		                    // Filter the payload based on the numberOfVotes
		                    var filteredPayload = payload.filter(function(item) {
		                        return item.downVotes < numberOfVotes;
		                    });
		
		                    // Replace the original payload with the filtered payload
		                    mc.setPayloadJSON(filteredPayload);]]></script>
                    <respond/>
                </default>
            </switch>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/reviews/quantityByUser/{user}">
        <inSequence>
            <log description="request log">
                <property name="message" value="Welcome to ACME - Get quantity of reviews by user"/>
            </log>
            <property description="SET User Property" expression="$ctx:uri.var.user" name="userProperty" scope="default" type="STRING"/>
            <call>
                <endpoint key="ReviewsEndpoint"/>
            </call>
            <script language="js"><![CDATA[var payload = mc.getPayloadJSON();
		    var Reviews = payload.length;
		   	var responsePayload = {
        			Total_Number_of_Reviews: Reviews,
    		};
		    // Set the response payload
		    mc.setPayloadJSON(responsePayload);]]></script>
            <respond/>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </resource>
</api>
